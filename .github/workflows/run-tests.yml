name: ðŸ§ª Run Java Tests (Self-Diagnose)
on:
 push:
   branches: [ main, develop ]
 pull_request:
   branches: [ main, develop ]
jobs:
 build:
   runs-on: ubuntu-latest
   steps:
     - name: ðŸ§© Checkout repository
       uses: actions/checkout@v4
     - name: â˜• Set up Java 17
       uses: actions/setup-java@v4
       with:
         distribution: 'temurin'
         java-version: '17'
     - name: ðŸ”Ž Print Java & OS info
       run: |
         set -x
         java -version
         javac -version
         uname -a
     - name: ðŸ—‚ï¸ Show project tree (first 3 levels)
       run: |
         sudo apt-get update -y
         sudo apt-get install -y tree
         tree -L 3 -a || true
     - name: ðŸ§° Download JUnit Console
       run: |
         set -e
         mkdir -p libs
         curl -L -o libs/junit-platform-console-standalone.jar https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.9.3/junit-platform-console-standalone-1.9.3.jar
         ls -lh libs
     - name: ðŸ§¹ Discover source roots (common student layouts)
       id: discover
       run: |
         set -e
         CANDIDATES=("src/main/java" "src" "ReturnABook/src/main/java" "ReturnABook/src" ".")
         ROOT=""
         for p in "${CANDIDATES[@]}"; do
           if [ -d "$p" ] && find "$p" -type f -name "*.java" | grep -q .; then
             ROOT="$p"
             break
           fi
         done
         if [ -z "$ROOT" ]; then
           echo "âŒ No Java sources found in common paths." | tee -a discover.log
           echo "root=" >> $GITHUB_OUTPUT
           exit 1
         fi
         echo "âœ… Using source root: $ROOT" | tee -a discover.log
         echo "root=$ROOT" >> $GITHUB_OUTPUT
     - name: ðŸ§¼ Clean & prepare out dir
       run: |
         rm -rf out
         mkdir -p out
     - name: ðŸ—ï¸ Compile MAIN sources
       id: compile_main
       continue-on-error: true
       run: |
         set -e
         ROOT="${{ steps.discover.outputs.root }}"
         if [ -d "$ROOT" ]; then
           find "$ROOT" -type f -name "*.java" > main-sources.txt
         else
           find . -type f -name "*.java" ! -path "*/test/*" > main-sources.txt
         fi
         echo "---- MAIN SOURCES ----" > compile-main.log
         cat main-sources.txt >> compile-main.log || true
         echo "----------------------" >> compile-main.log
         if [ -s main-sources.txt ]; then
           javac -d out -encoding UTF-8 -cp libs/junit-platform-console-standalone.jar @"main-sources.txt" 2>> compile-main.log
         else
           echo "â„¹ï¸ No main sources found to compile." | tee -a compile-main.log
         fi
     - name: ðŸ§ª Compile TEST sources
       id: compile_test
       continue-on-error: true
       run: |
         set -e
         CAND_TEST=("src/test/java" "ReturnABook/src/test/java" "test" "tests")
         TESTROOT=""
         for t in "${CAND_TEST[@]}"; do
           if [ -d "$t" ] && find "$t" -type f -name "*.java" | grep -q .; then
             TESTROOT="$t"
             break
           fi
         done
         echo "---- TEST SOURCES ----" > compile-test.log
         if [ -n "$TESTROOT" ]; then
           find "$TESTROOT" -type f -name "*.java" > test-sources.txt
           cat test-sources.txt >> compile-test.log
           echo "----------------------" >> compile-test.log
           javac -d out -encoding UTF-8 -cp "libs/junit-platform-console-standalone.jar:out" @"test-sources.txt" 2>> compile-test.log
         else
           echo "â„¹ï¸ No test sources found." | tee -a compile-test.log
           echo "found=false" >> $GITHUB_OUTPUT
           exit 0
         fi
         echo "found=true" >> $GITHUB_OUTPUT
     - name: â–¶ï¸ Run JUnit Console (if tests exist)
       if: steps.compile_test.outputs.found == 'true'
       continue-on-error: true
       run: |
         set -e
         echo "---- JUNIT RUN ----" > junit-run.log
         java -jar libs/junit-platform-console-standalone.jar \
           --class-path out \
           --scan-class-path 2>> junit-run.log
     - name: ðŸ“¦ Upload logs (always)
       if: always()
       uses: actions/upload-artifact@v4
       with:
         name: build-logs
         path: |
           discover.log
           compile-main.log
           compile-test.log
           junit-run.log
           main-sources.txt
           test-sources.txt
         if-no-files-found: ignore
